@page "/register"
@using SistemaPDV.Core.DTOs
@using SistemaPDV.Web.Services
@inject IAuthWebService AuthService
@inject NavigationManager Navigation
@inject IHttpClientFactory HttpClientFactory

<PageTitle>Registrar - Sistema PDV</PageTitle>

<div class="container-fluid vh-100 d-flex align-items-center justify-content-center bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="row w-100 justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <i class="fas fa-utensils fa-3x text-primary mb-3"></i>
                        <h3 class="fw-bold">Registrar Restaurante</h3>
                        <p class="text-muted">Cadastre seu restaurante e usuário administrador</p>
                    </div>

                    @if (!string.IsNullOrEmpty(mensagemErro))
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>@mensagemErro
                            <button type="button" class="btn-close" @onclick="() => mensagemErro = string.Empty"></button>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(mensagemSucesso))
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>@mensagemSucesso
                            <button type="button" class="btn-close" @onclick="() => mensagemSucesso = string.Empty"></button>
                        </div>
                    }

                    <form @onsubmit="@FazerRegistro" @onsubmit:preventDefault="true">
                        <!-- Dados do Usuário Administrador -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-user me-2"></i>Dados do Usuário Administrador</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label">Email *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-envelope"></i>
                                            </span>
                                            <input type="email" id="email" class="form-control" placeholder="seu@email.com" 
                                                   autocomplete="email"
                                                   @bind="registerDto.Email" required />
                                        </div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label for="senha" class="form-label">Senha *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-lock"></i>
                                            </span>
                                            <input type="password" id="senha" class="form-control" placeholder="Mínimo 6 caracteres"
                                                   autocomplete="new-password"
                                                   @bind="registerDto.Password" required minlength="6" />
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="nome" class="form-label">Nome do Responsável *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-user"></i>
                                        </span>
                                        <input type="text" id="nome" class="form-control" placeholder="Nome completo do responsável"
                                               autocomplete="name"
                                               @bind="registerDto.Nome" required />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dados do Restaurante -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-utensils me-2"></i>Dados do Restaurante</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8 mb-3">
                                        <label for="nomeRestaurante" class="form-label">Nome do Restaurante *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-store"></i>
                                            </span>
                                            <input type="text" id="nomeRestaurante" class="form-control" placeholder="Nome do seu restaurante"
                                                   autocomplete="organization"
                                                   @bind="restauranteDto.Nome" required />
                                        </div>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label for="cnpj" class="form-label">CNPJ</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-file-invoice"></i>
                                            </span>
                                            <input type="text" id="cnpj" class="form-control" placeholder="00.000.000/0000-00"
                                                   autocomplete="off"
                                                   @bind="restauranteDto.CNPJ" maxlength="18" />
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="telefone" class="form-label">Telefone</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-phone"></i>
                                            </span>
                                            <input type="text" id="telefone" class="form-control" placeholder="(11) 99999-9999"
                                                   autocomplete="tel"
                                                   @bind="restauranteDto.Telefone" />
                                        </div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label for="emailRestaurante" class="form-label">Email do Restaurante</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-envelope"></i>
                                            </span>
                                            <input type="email" id="emailRestaurante" class="form-control" placeholder="contato@restaurante.com"
                                                   autocomplete="email"
                                                   @bind="restauranteDto.Email" />
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="endereco" class="form-label">Endereço</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-map-marker-alt"></i>
                                        </span>
                                        <input type="text" id="endereco" class="form-control" placeholder="Rua, Avenida..."
                                               autocomplete="street-address"
                                               @bind="restauranteDto.Endereco" />
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-2 mb-3">
                                        <label for="numero" class="form-label">Número</label>
                                        <input type="text" id="numero" class="form-control" placeholder="123"
                                               autocomplete="off"
                                               @bind="restauranteDto.Numero" />
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label for="complemento" class="form-label">Complemento</label>
                                        <input type="text" id="complemento" class="form-control" placeholder="Apto, Sala..."
                                               autocomplete="off"
                                               @bind="restauranteDto.Complemento" />
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label for="bairro" class="form-label">Bairro</label>
                                        <input type="text" id="bairro" class="form-control" placeholder="Nome do bairro"
                                               autocomplete="address-level2"
                                               @bind="restauranteDto.Bairro" />
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="cidade" class="form-label">Cidade</label>
                                        <input type="text" id="cidade" class="form-control" placeholder="Nome da cidade"
                                               autocomplete="address-level2"
                                               @bind="restauranteDto.Cidade" />
                                    </div>

                                    <div class="col-md-3 mb-3">
                                        <label for="uf" class="form-label">UF</label>
                                        <select id="uf" class="form-select" @bind="restauranteDto.UF">
                                            <option value="">Selecione...</option>
                                            <option value="AC">AC</option>
                                            <option value="AL">AL</option>
                                            <option value="AP">AP</option>
                                            <option value="AM">AM</option>
                                            <option value="BA">BA</option>
                                            <option value="CE">CE</option>
                                            <option value="DF">DF</option>
                                            <option value="ES">ES</option>
                                            <option value="GO">GO</option>
                                            <option value="MA">MA</option>
                                            <option value="MT">MT</option>
                                            <option value="MS">MS</option>
                                            <option value="MG">MG</option>
                                            <option value="PA">PA</option>
                                            <option value="PB">PB</option>
                                            <option value="PR">PR</option>
                                            <option value="PE">PE</option>
                                            <option value="PI">PI</option>
                                            <option value="RJ">RJ</option>
                                            <option value="RN">RN</option>
                                            <option value="RS">RS</option>
                                            <option value="RO">RO</option>
                                            <option value="RR">RR</option>
                                            <option value="SC">SC</option>
                                            <option value="SP">SP</option>
                                            <option value="SE">SE</option>
                                            <option value="TO">TO</option>
                                        </select>
                                    </div>

                                    <div class="col-md-3 mb-3">
                                        <label for="cep" class="form-label">CEP</label>
                                        <input type="text" id="cep" class="form-control" placeholder="00000-000"
                                               autocomplete="postal-code"
                                               @bind="restauranteDto.CEP" maxlength="9" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid mb-3">
                            <button type="submit" class="btn btn-success btn-lg" disabled="@efetuandoRegistro">
                                @if (efetuandoRegistro)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                <i class="fas fa-save me-2"></i>Registrar Restaurante
                            </button>
                        </div>

                        <div class="text-center">
                            <a href="/login" class="btn btn-link">
                                <i class="fas fa-arrow-left me-2"></i>Voltar ao Login
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private RegisterDto registerDto = new();
    private RestauranteRegistroDto restauranteDto = new();
    private bool efetuandoRegistro = false;
    private string mensagemErro = string.Empty;
    private string mensagemSucesso = string.Empty;

    private async Task FazerRegistro()
    {
        if (string.IsNullOrWhiteSpace(registerDto.Email) || 
            string.IsNullOrWhiteSpace(registerDto.Password) ||
            string.IsNullOrWhiteSpace(registerDto.Nome) ||
            string.IsNullOrWhiteSpace(restauranteDto.Nome))
        {
            mensagemErro = "Por favor, preencha todos os campos obrigatórios.";
            return;
        }

        if (registerDto.Password.Length < 6)
        {
            mensagemErro = "A senha deve ter pelo menos 6 caracteres.";
            return;
        }

        efetuandoRegistro = true;
        mensagemErro = string.Empty;
        mensagemSucesso = string.Empty;

        try
        {
            // Criar objeto combinado para envio
            var registroCompleto = new RegistroCompletoDto
            {
                Usuario = registerDto,
                Restaurante = restauranteDto
            };

            using var httpClient = HttpClientFactory.CreateClient("Default");
            var response = await httpClient.PostAsJsonAsync("api/auth/register-complete", registroCompleto);

            if (response.IsSuccessStatusCode)
            {
                mensagemSucesso = "Restaurante registrado com sucesso! Redirecionando para login...";
                
                // Aguardar 2 segundos e redirecionar para login
                await Task.Delay(2000);
                Navigation.NavigateTo("/login?message=Registrado com sucesso!");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                mensagemErro = $"Erro ao registrar: {errorContent}";
            }
        }
        catch (Exception ex)
        {
            mensagemErro = $"Erro de conexão: {ex.Message}";
        }
        finally
        {
            efetuandoRegistro = false;
        }
    }

    // DTOs locais (usando os mesmos do Core)
    public class RegistroCompletoDto
    {
        public RegisterDto Usuario { get; set; } = new();
        public RestauranteRegistroDto Restaurante { get; set; } = new();
    }

    public class RestauranteRegistroDto
    {
        public string Nome { get; set; } = string.Empty;
        public string? CNPJ { get; set; }
        public string? Telefone { get; set; }
        public string? Email { get; set; }
        public string? Endereco { get; set; }
        public string? Numero { get; set; }
        public string? Complemento { get; set; }
        public string? Bairro { get; set; }
        public string? Cidade { get; set; }
        public string? UF { get; set; }
        public string? CEP { get; set; }
    }
}
